---
title: "hw10"
author: "張瑜君"
date: "2019年5月6日"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## 02_sales_analysis_code_checkpoint_4.R

#1.Load libraries
```{r}
library(tidyverse)
library(lubridate)
library(tidyquant)
library(readxl)
library(writexl)
```


#2.Importing Files 
```{r}
bikes_tbl <- read_excel("bikes.xlsx")
bikeshops_tbl <- read_excel("bikeshops.xlsx")
orderlines_tbl <- read_excel("orderlines.xlsx")
```


#3.Examining Data
```{r}
bikes_tbl
glimpse(bikes_tbl)
bikeshops_tbl
orderlines_tbl
```


#4.Joining Data
```{r}
left_join(orderlines_tbl, bikes_tbl, by = c("product.id"="bike.id"))
orderlines_bikes_tbl <- orderlines_tbl %>% left_join(bikes_tbl, by = c("product.id"="bike.id"))
orderlines_tbl %>% left_join(bikes_tbl, by = c("product.id"="bike.id")) %>% 
                   left_join(bikeshops_tbl, by = c("customer.id" = "bikeshop.id"))
bikes_orderlines_joined_tbl<-orderlines_tbl %>% left_join(bikes_tbl, by = c("product.id" = "bike.id")) %>% 
  left_join(bikeshops_tbl, by = c("customer.id" = "bikeshop.id"))
bikes_orderlines_joined_tbl
bikes_orderlines_joined_tbl %>% glimpse()
```


#5.Wrangling Data

共有order_date、order_id、order_line、quantity、price、total_price、model、category_1、category_2、frame_material、bikeshop_name、city、state。
```{r}
bikes_orderlines_wrangled_tbl <- bikes_orderlines_joined_tbl %>%
  separate(description,
           into = c("category.1", "category.2", "frame.material"),
           sep = " - ",
           remove = TRUE) %>%
  separate(location,
           into = c("city", "state"),
           sep  = ", ",
           remove = FALSE) %>%
  mutate(total.price = price * quantity) %>%
  select(-1, -location) %>%
  select(-ends_with(".id")) %>%
  bind_cols(bikes_orderlines_joined_tbl %>% select(order.id)) %>%
  select(contains("date"), contains("id"), contains("order"),
         quantity, price, total.price,
         everything()) %>%
  rename(order_date = order.date) %>%
  set_names(names(.) %>% str_replace_all("\\.", "_")) 
bikes_orderlines_wrangled_tbl %>% glimpse()
```


#6.Business Insights

#6-1.Sales by Year

Step1 - Manipulate
```{r}
sales_by_year_tbl <- bikes_orderlines_wrangled_tbl %>%
  select(order_date, total_price) %>%
  mutate(year = year(order_date)) %>%
  group_by(year) %>%
  summarize(sales = sum(total_price)) %>%
  ungroup() %>%
  mutate(sales_text = scales::dollar(sales))
sales_by_year_tbl
```


Step2 - Visualize
```{r}
sales_by_year_tbl %>%
  ggplot(aes(x = year, y = sales)) +
  geom_col(fill = "#2c3e50") +
  geom_label(aes(label = sales_text)) +
  geom_smooth(method = "lm", se = FALSE) +
  theme_tq() +
  scale_y_continuous(labels = scales::dollar) +
  labs(
    title = "Revenue by Year",
    subtitle = "Upward trend",
    x = "",
    y = "Revenue")
```


#6-2.Sales by Year and Category 2

Step1 - Manipulate
```{r}
sales_by_year_cat_2_tbl <- bikes_orderlines_wrangled_tbl %>%
  select(order_date, total_price, category_2) %>%
  mutate(year = year(order_date)) %>%
  group_by(year, category_2) %>%
  summarise(sales = sum(total_price)) %>%
  ungroup() %>%
  mutate(sales_text = scales::dollar(sales))
sales_by_year_cat_2_tbl
```


Step2 - Visualize
```{r}
p = sales_by_year_cat_2_tbl %>%
  ggplot(aes(x = year, y = sales, fill = category_2)) +
  geom_col() +
  geom_smooth(method = "lm", se = FALSE) +
  facet_wrap(~ category_2, ncol = 3, scales = "free_y") +
  theme_tq() +
  scale_fill_tq() +
  scale_y_continuous(labels = scales::dollar) +
  labs(
    title = "Revenue by Year and Category 2",
    subtitle = "Each product category has an upward trend",
    x = "",
    y = "Revenue",
    fill = "Product Secondary Category")
p
```


轉換成PDF，並儲存成pdf檔及png檔。
```{r}
pdf("ggplot.pdf")
print(p)
dev.off()

ggsave("myplot.pdf")
ggsave("myplot.png")
ggsave("myplot.png" , plot = p)
```


#7.Writing Files

1.fs設定一個新的目錄。

2.利用write_xlsx將檔案儲存為xlsx檔。

3.利用write_csv將檔案儲存為csv檔。

4.利用write_rds將檔案儲存為rds檔。
```{r}
fs::dir_create("data_wrangled_student")

bikes_orderlines_wrangled_tbl %>%
  write_xlsx("data_wrangled_student/bike_orderlines.xlsx")


bikes_orderlines_wrangled_tbl %>%
  write_csv("data_wrangled_student/bike_orderlines.csv")

bikes_orderlines_wrangled_tbl %>%
  write_rds("data_wrangled_student/bike_orderlines.rds")
```


## 台灣上市公司(不含TDR)之日收盤調整後股價

讀取「台灣上市公司(不含TDR)之日收盤調整後股價」，把第二欄-簡稱刪除。

並將證券代碼那一欄設定為id，年月日設定為date，收盤價設定為price。
```{r}
day.price = read.table("D:/gittest/01/0506/price_2010_2018_day.txt")
day.price <- day.price[,-2]
colnames(day.price) <- c("id", "", "",  "date", "price")
head(day.price)
```


#利用dcast，將長資料轉換為寬資料型態。
```{r}
library(data.table)
dayprice.reorder = dcast(day.price,date~id)
dim(dayprice.reorder)
head(dayprice.reorder)
```


#將dayprice.reorder存檔為rds檔。
```{r}
write_rds(dayprice.reorder, "dayprice.reorder.rds")
```

